{% extends "base.html" %}
{% block title %}{{ game.title }}{% endblock %}

{% block content %}
  <div class="main">
    <h1>{{ game.title }}</h1>
    <p>{{ game.description }}</p>

    {% if game.image_url %}
      <img src="{{ game.image_url }}" alt="{{ game.title }}" />
    {% else %}
      <img src="/static/images/placeholder.jpg" alt="Brak okładki">
    {% endif %}

    <p><strong>Wydawca:</strong>
      <a href="/producer/{{ game.producer_id }}">
        {{ game.producer_name }}
      </a>
    </p>

    <p><strong>Data premiery:</strong> {{ game.release_date }}</p>
    <p><strong>Gatunek:</strong> {{ game.genre }}</p>
  </div>

  <h2>Osiągnięcia</h2>
  {% if achievements %}
    <ul class="achievement-list">
      {% for a in achievements %}
        <li class="achievement-item">
          <span class="achievement-title" onclick="toggleDescription('desc-{{ a.id }}')">
            🏆 {{ a.name }} ({{ a.points }} pkt)
          </span>
          <div id="desc-{{ a.id }}" class="achievement-description hidden">
            <p>{{ a.description or "Brak opisu." }}</p>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Brak osiągnięć dla tej gry.</p>
  {% endif %}

  <a href="/">← Wróć na stronę główną</a>
{% endblock %}

{% block scripts %}

{% if request.cookies.get("access_token") %}
  <form id="library-form" method="post" action="/game/{{ game.id }}/add_to_library" style="display:inline;">
    <button type="submit">Dodaj do biblioteki</button>
  </form>

  <form id="wishlist-form" method="post" action="/game/{{ game.id }}/add_to_wishlist" style="display:inline;">
    <button type="submit">Dodaj do wishlisty</button>
  </form>
{% else %}
  <p><a href="/login">Zaloguj się</a>, aby dodawać gry do biblioteki i wishlisty.</p>
{% endif %}

<h2>Recenzje</h2>
{% if ratings %}
  <ul class="ratings-list">
    {% for r in ratings %}
      <li>
        <strong>{{ r.username }}</strong> -
        Ocena: {{ r.rating }} / 10<br>
        <em>{{ r.description or "Brak opisu." }}</em><br>
        <small>Dodano: {{ r.rated_at.strftime('%Y-%m-%d %H:%M') }}</small>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>Brak recenzji dla tej gry.</p>
{% endif %}



<script>
  function toggleDescription(id) {
    const el = document.getElementById(id);
    el.classList.toggle("hidden");
  }

   async function postForm(url) {
    const response = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin'
    });
    const data = await response.json();
    alert(data.message);
  }

  document.getElementById("library-form").addEventListener("submit", function(e) {
    e.preventDefault();
    postForm(this.action);
  });

  document.getElementById("wishlist-form").addEventListener("submit", function(e) {
    e.preventDefault();
    postForm(this.action);
  });

</script>
{% endblock %}
