{% extends "base.html" %}
{% block title %}Not Steam - {{ game.title }}{% endblock %}

{% block content %}
<div class="game-container">
  <!-- Hero Section -->
  <section class="game-hero">
    <div class="game-hero-content">
      <div class="game-info">
        <h1 class="game-title">{{ game.title }}</h1>
        <div class="game-meta">
          <div class="game-description">
            <p>{{ game.description }}</p>
          </div>
          <div class="game-actions">
            <a href="{{ game.itch_link }}" target="_blank" rel="noopener noreferrer" class="itch-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              Zagraj na itch.io
            </a>

            {% if user %}
            <div class="user-actions">
              <button class="action-btn library-btn" data-action="/library/add/{{ game.id }}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
                Dodaj do biblioteki
              </button>
              <button class="action-btn wishlist-btn" data-action="/wishlist/add/{{ game.id }}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
                Dodaj do wishlisty
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="game-image">
        <img src="{{ game.image_url or '/static/images/placeholder.jpg' }}" alt="{{ game.title }}" />
        <div class="image-overlay"></div>
      </div>
    </div>
  </section>

  <!-- Content Grid -->
  <div class="game-content-grid">
    <!-- Achievements Section -->
    <section class="achievements-section">
      <div class="section-header">
        <h2>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Osiągnięcia
        </h2>
        <span class="section-count">{{ achievements|length }}</span>
      </div>

      <div class="achievements-grid">
        {% for achievement in achievements %}
        <div class="achievement-card">
          <div class="achievement-header">
            <h3>{{ achievement.name }}</h3>
            <button class="toggle-btn" onclick="toggleDescription('desc{{ achievement.id }}')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6,9 12,15 18,9"/>
              </svg>
            </button>
          </div>
          <div id="desc{{ achievement.id }}" class="achievement-description hidden">
            <p>{{ achievement.description }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- Reviews Section -->
    <section class="reviews-section">
      <div class="section-header">
        <h2>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Recenzje
        </h2>
        <span class="section-count">{{ ratings|length }}</span>
      </div>

      <div class="reviews-list">
        {% for rating in ratings %}
        <div class="review-card">
          <div class="review-header">
            <div class="reviewer-info">
              <div class="reviewer-avatar">
                {{ rating.username[0]|upper }}
              </div>
              <span class="reviewer-name">{{ rating.username }}</span>
            </div>
            <div class="review-rating">
              {% for i in range(1, 6) %}
                <span class="star">★</span>
              {% endfor %}
            </div>
          </div>
          <div class="review-content">
            <p>{{ rating.description }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
  </div>

  <!-- Friends With Game in Library Section -->
  <section class="friends-section">
    <div class="section-header">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Znajomi z tą grą w bibliotece
      </h2>
    </div>

    {% if library_friends %}
    <div class="friends-grid">
      {% for username in library_friends %}
      <div class="friend-card">
        <div class="friend-avatar">{{ username[0]|upper }}</div>
        <div class="friend-info">
          <a href="/user/{{ username }}" class="friend-name">{{ username }}</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <p>Brak znajomych, którzy mają tę grę w bibliotece.</p>
    </div>
    {% endif %}
  </section>

  <!-- Friends With Game in Wishlist Section -->
  <section class="friends-section">
    <div class="section-header">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Znajomi z tą grą na liście życzeń
      </h2>
    </div>

    {% if wishlist_friends %}
    <div class="friends-grid">
      {% for username in wishlist_friends %}
      <div class="friend-card">
        <div class="friend-avatar">{{ username[0]|upper }}</div>
        <div class="friend-info">
          <a href="/user/{{ username }}" class="friend-name">{{ username }}</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <p>Brak znajomych, którzy mają tę grę na liście życzeń.</p>
    </div>
    {% endif %}
  </section>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Toggle achievement descriptions
  function toggleDescription(id) {
    const elem = document.getElementById(id);
    if (!elem) return;

    const isHidden = elem.classList.contains('hidden');
    const button = elem.parentElement.querySelector('.toggle-btn svg');

    elem.classList.toggle('hidden');

    // Animate the arrow
    if (isHidden) {
      button.style.transform = 'rotate(180deg)';
    } else {
      button.style.transform = 'rotate(0deg)';
    }
  }

  // Handle user actions (library/wishlist)
  document.addEventListener('DOMContentLoaded', function() {
    const actionButtons = document.querySelectorAll('.action-btn');

    actionButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const action = this.dataset.action;

        this.classList.add('loading');
        this.disabled = true;

        fetch(action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          this.classList.remove('loading');
          this.disabled = false;
          this.classList.add('success');
          setTimeout(() => {
            this.classList.remove('success');
          }, 2000);
        })
        .catch(error => {
          console.error('Error:', error);
          this.classList.remove('loading');
          this.disabled = false;
        });
      });
    });
  });
</script>
{% endblock %}
