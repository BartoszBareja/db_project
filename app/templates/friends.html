{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/styles/friends.css?v={{ time }}" />
<div class="main">
    <h2 class="section-title">Twoi znajomi</h2>
</div>

<div class="tiles-section">
    <h2 class="section-title">Lista znajomych</h2>
    <div class="tiles-grid">
        {% if friends %}
            {% for friend in friends %}
            <div class="tile friend-tile">
                <p><strong>{{ friend.username }}</strong></p>
                <button class="chat-button" onclick="toggleChat({{ friend.id }}, '{{ friend.username }}')">ðŸ’¬ Czat</button>

                <div id="chat-box-{{ friend.id }}" class="chat-box" style="display:none;">
                    <div id="messages-{{ friend.id }}" class="message-list"></div>
                    <div class="chat-input-row">
                        <input id="input-{{ friend.id }}" type="text" class="chat-input" placeholder="Napisz wiadomoÅ›Ä‡...">
                        <button class="send-button" onclick="sendMessage({{ friend.id }})">WyÅ›lij</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center;">Nie masz jeszcze Å¼adnych znajomych ðŸ˜¢</p>
        {% endif %}
    </div>
</div>

<script>
    const currentUserId = {{ current_user.id }};
    const friendUsernames = {
        {% for friend in friends %}
            {{ friend.id }}: "{{ friend.username }}",
        {% endfor %}
    };

    const sockets = {};

    function toggleChat(friendId, friendName) {
        const chatBox = document.getElementById(`chat-box-${friendId}`);
        const messagesDiv = document.getElementById(`messages-${friendId}`);

        // JeÅ›li chat jest widoczny - ukryj i zakoÅ„cz
        if (chatBox.style.display === 'block') {
            chatBox.style.display = 'none';
            return;
        }

        // Ukryj inne czaty
        document.querySelectorAll('[id^="chat-box-"]').forEach(div => {
            if(div.id !== `chat-box-${friendId}`) div.style.display = 'none';
        });

        // PokaÅ¼ wybrany czat
        chatBox.style.display = 'block';
        messagesDiv.innerHTML = "";

        fetch(`/chat/history/${currentUserId}/${friendId}`)
            .then(res => res.json())
            .then(history => {
                history.forEach(msg => {
                    const p = document.createElement('p');
                    const date = new Date(msg.timestamp);
                    const timeStr = date.toLocaleString();
                    const senderLabel = (msg.sender_id === currentUserId) ? "Ty" : friendUsernames[msg.sender_id] || "Znajomy";
                    p.textContent = `${senderLabel} [${timeStr}]: ${msg.content}`;
                    messagesDiv.appendChild(p);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });

        if (!sockets[friendId]) {
            const ws = new WebSocket(`ws://${window.location.host}/ws/chat/${currentUserId}/${friendId}`);
            sockets[friendId] = ws;

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const senderLabel = (data.sender_id === currentUserId) ? "Ty" : friendUsernames[data.sender_id] || "Znajomy";
                const date = new Date(data.timestamp);
                const timeStr = date.toLocaleString();
                const p = document.createElement('p');
                p.textContent = `${senderLabel} [${timeStr}]: ${data.content}`;
                messagesDiv.appendChild(p);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            ws.onclose = () => {
                const p = document.createElement('p');
                p.textContent = "Czat zakoÅ„czony.";
                messagesDiv.appendChild(p);
            };

            ws.onerror = (e) => {
                console.error("WebSocket error:", e);
            };
        }
    }

    function sendMessage(friendId) {
        const input = document.getElementById(`input-${friendId}`);
        const msg = input.value.trim();
        if (msg && sockets[friendId] && sockets[friendId].readyState === WebSocket.OPEN) {
            sockets[friendId].send(msg);
            const messagesDiv = document.getElementById(`messages-${friendId}`);
            const date = new Date();
            const timeStr = date.toLocaleString();
            const p = document.createElement('p');
            p.textContent = `Ty [${timeStr}]: ${msg}`;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';
        }
    }
</script>
{% endblock %}
